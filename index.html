<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Terraria Clone with Self Destruct Button</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: Arial, sans-serif;
        background-color: #FFF0F5;
    }
    #game-container {
        width: 100%;
        height: calc(100% - 150px);
        background-color: #FFE4E1;
        border: 4px solid #FFC0CB;
        position: relative;
        overflow: hidden;
    }
    #welcome-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 192, 203, 0.9);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        font-size: 18px;
        color: #4B0082;
        z-index: 1000;
        display: none;
    }
    #cat-player {
        width: 32px;
        height: 48px;
        position: absolute;
        transition: all 0.1s;
    }
    .block {
        width: 32px;
        height: 32px;
        position: absolute;
        background-color: #FFB6C1;
        border: 2px solid #FFA3B1;
        border-radius: 5px;
    }
    #inventory {
        position: fixed;
        bottom: 160px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 192, 203, 0.5);
        padding: 10px;
        border-radius: 5px;
    }
    .inventory-slot {
        width: 40px;
        height: 40px;
        background-color: #FFC0CB;
        display: inline-block;
        margin: 0 5px;
        border: 2px solid #FFA3B1;
    }
    #chat-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 150px;
        background-color: rgba(255, 192, 203, 0.7);
        color: #4B0082;
        display: flex;
        flex-direction: column;
    }
    #chat-log {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        font-size: 14px;
    }
    #chat-input {
        display: flex;
        padding: 10px;
    }
    #chat-input input {
        flex-grow: 1;
        padding: 5px;
        font-size: 14px;
        border: 2px solid #FFA3B1;
        background-color: #FFF0F5;
    }
    #chat-input button {
        padding: 5px 10px;
        margin-left: 5px;
        background-color: #FFC0CB;
        color: #4B0082;
        border: none;
    }
    .speech-bubble {
        position: absolute;
        background-color: #FFC0CB;
        color: #4B0082;
        border-radius: 10px;
        padding: 5px 10px;
        font-size: 12px;
        max-width: 150px;
        word-wrap: break-word;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        transform: translate(-50%, -100%);
    }
    .speech-bubble::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        border-width: 10px 10px 0;
        border-style: solid;
        border-color: #FFC0CB transparent;
        transform: translateX(-50%);
    }
    .glitch {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9998;
        opacity: 0;
        transition: opacity 0.5s;
    }
    .glitch-active {
        opacity: 1;
    }
    @keyframes explosion {
        0% { transform: scale(0); opacity: 1; }
        80% { transform: scale(1.5); opacity: 0.7; }
        100% { transform: scale(2); opacity: 0; }
    }
    .bomb-explosion {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, #ff4136, #ff851b, #ffdc00);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        animation: explosion 1s ease-out forwards;
    }
    #control-guide {
        position: fixed;
        top: 10px;
        left: 10px;
        background-color: rgba(255, 192, 203, 0.7);
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
        color: #4B0082;
        z-index: 1000;
    }
    #control-guide h3 {
        margin-top: 0;
        margin-bottom: 5px;
    }
    #control-guide p {
        margin: 5px 0;
    }
    #secret-trigger {
        position: absolute;
        top: 0;
        right: 0;
        width: 20px;
        height: 20px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s;
    }
    #secret-trigger:hover {
        opacity: 0.1;
    }
    #virtual-piano {
        position: fixed;
        bottom: 160px;
        left: 10px;
        display: flex;
        background-color: #333;
        padding: 5px;
        border-radius: 5px;
        z-index: 1000;
    }
    .piano-key {
        width: 30px;
        height: 100px;
        background-color: white;
        border: 1px solid #ccc;
        margin: 0 2px;
        cursor: pointer;
        transition: background-color 0.1s;
    }
    .piano-key:active,
    .piano-key.active {
        background-color: #e0e0e0;
    }
    #horror-piano {
        position: fixed;
        bottom: 160px;
        right: 10px;
        display: flex;
        background-color: #111;
        padding: 5px;
        border-radius: 5px;
        z-index: 1001;
    }
    #horror-piano .piano-key {
        width: 30px;
        height: 100px;
        background-color: #333;
        border: 1px solid #222;
        margin: 0 2px;
        cursor: pointer;
        transition: background-color 0.1s;
    }
    #horror-piano .piano-key:active,
    #horror-piano .piano-key.active {
        background-color: #555;
    }
    #restart-button {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        font-size: 18px;
        background-color: #ff00ff;
        color: #00ffff;
        border: 3px solid #00ff00;
        border-radius: 5px;
        cursor: pointer;
        display: none;
        animation: glitch 0.3s infinite;
        z-index: 10001;
    }
    @keyframes glitch {
        0% { transform: translateX(-50%) skew(0deg, 0deg); }
        20% { transform: translateX(-52%) skew(-2deg, 2deg); }
        40% { transform: translateX(-48%) skew(2deg, -2deg); }
        60% { transform: translateX(-51%) skew(-1deg, 1deg); }
        80% { transform: translateX(-49%) skew(1deg, -1deg); }
        100% { transform: translateX(-50%) skew(0deg, 0deg); }
    }
</style>
</head>
<body>
<div id="game-container">
    <div id="welcome-message">
        <p>Welcome to hello kitty's adventure world!</p>
        <p>A wholesome place where nothing can go wrong. :)</p>
        <p>Will you discover the mysteries and rescue the lost porygon?</p>
    </div>
    <svg id="cat-player" width="32" height="48" viewBox="0 0 32 48" style="position: absolute;">
        <path d="M16 0 L32 32 L24 48 L8 48 L0 32 Z" fill="#FFA3B1"/>
        <circle cx="10" cy="20" r="3" fill="black"/>
        <circle cx="22" cy="20" r="3" fill="black"/>
        <path d="M13 28 Q16 32 19 28" stroke="black" stroke-width="2" fill="none"/>
    </svg>
    <div id="secret-trigger"></div>
</div>
<div id="inventory"></div>
<div id="chat-container">
    <div id="chat-log"></div>
    <div id="chat-input">
        <input type="text" id="chat-message" placeholder="Type your message...">
        <button id="chat-send">Send</button>
    </div>
</div>
<div class="glitch" id="glitch-overlay"></div>
<div id="control-guide">
    <h3>Controls:</h3>
    <p>← → : Move left/right</p>
    <p>Quick space : Jump</p>
    <p>Click : Place block</p>
</div>
<div id="virtual-piano">
    <div class="piano-key" data-note="C4"></div>
    <div class="piano-key" data-note="D4"></div>
    <div class="piano-key" data-note="E4"></div>
    <div class="piano-key" data-note="F4"></div>
    <div class="piano-key" data-note="G4"></div>
    <div class="piano-key" data-note="A4"></div>
    <div class="piano-key" data-note="B4"></div>
    <div class="piano-key" data-note="C5"></div>
</div>
<div id="horror-piano" style="display: none;">
    <div class="piano-key" data-note="C2"></div>
    <div class="piano-key" data-note="D2"></div>
    <div class="piano-key" data-note="E2"></div>
    <div class="piano-key" data-note="F2"></div>
    <div class="piano-key" data-note="G2"></div>
    <div class="piano-key" data-note="A2"></div>
    <div class="piano-key" data-note="B2"></div>
    <div class="piano-key" data-note="C3"></div>
</div>
<audio id="creepy-piano" loop>
  <source src="https://terrariaclone.com/creepy-piano.mp3" type="audio/mpeg">
  <source src="creepy-piano.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>
<audio id="horror-sounds" loop>
  <source src="https://terrariaclone.com/horror-sounds.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>
<button id="restart-button">Do you want a new opportunity in life?</button>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.3.7/pixi.min.js"></script>
<script>
    const JUMP_STRENGTH = -10;
    const MAX_JUMP_HOLD = 15;
    let isJumping = false;
    let jumpHoldTime = 0;

    const player = document.getElementById('cat-player');
    const gameContainer = document.getElementById('game-container');
    const inventory = document.getElementById('inventory');
    const chatLog = document.getElementById('chat-log');
    const chatMessage = document.getElementById('chat-message');
    const chatSend = document.getElementById('chat-send');
    const glitchOverlay = document.getElementById('glitch-overlay');
    const piano = document.getElementById('virtual-piano');
    const pianoKeys = piano.querySelectorAll('.piano-key');

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    const noteFrequencies = {
        'C4': 261.63,
        'D4': 293.66,
        'E4': 329.63,
        'F4': 349.23,
        'G4': 392.00,
        'A4': 440.00,
        'B4': 493.88,
        'C5': 523.25
    };

    const horrorNoteFrequencies = {
        'C2': 65.41,
        'D2': 73.42,
        'E2': 82.41,
        'F2': 87.31,
        'G2': 98.00,
        'A2': 110.00,
        'B2': 123.47,
        'C3': 130.81
    };

    const NPC_MESSAGES = [
        "I'm excited to plant a garden this weekend!",
        "Just finished reading a great book. It made me smile.",
        "Planning to volunteer at the local animal shelter tomorrow.",
        "Baked cookies for my neighbors today. Sharing is caring!",
        "Going to call my grandma later. She always brightens my day.",
        "Thinking about starting a new hobby. Any suggestions?",
        "Had a lovely picnic in the park earlier. Nature is beautiful!",
        "Helped a lost dog find its way home. What a rewarding experience!",
        "Looking forward to game night with friends this weekend.",
        "Decided to learn a new language. It's challenging but fun!"
    ];

    class NPC {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.direction = Math.random() < 0.5 ? -1 : 1;
            this.lastMessageTime = 0;
            this.messageInterval = Math.random() * 10000 + 5000; // 5-15 seconds
            this.element = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            this.element.setAttribute("width", "32");
            this.element.setAttribute("height", "48");
            this.element.setAttribute("viewBox", "0 0 32 48");
            this.element.style.position = 'absolute';
            this.color = `hsl(${Math.random() * 360}, 70%, 70%)`;
            
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", "M16 0 L32 32 L24 48 L8 48 L0 32 Z");
            path.setAttribute("fill", this.color);
            this.element.appendChild(path);

            const leftEye = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            leftEye.setAttribute("cx", "10");
            leftEye.setAttribute("cy", "20");
            leftEye.setAttribute("r", "3");
            leftEye.setAttribute("fill", "black");
            this.element.appendChild(leftEye);

            const rightEye = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            rightEye.setAttribute("cx", "22");
            rightEye.setAttribute("cy", "20");
            rightEye.setAttribute("r", "3");
            rightEye.setAttribute("fill", "black");
            this.element.appendChild(rightEye);

            const mouth = document.createElementNS("http://www.w3.org/2000/svg", "path");
            mouth.setAttribute("d", "M13 28 Q16 32 19 28");
            mouth.setAttribute("stroke", "black");
            mouth.setAttribute("stroke-width", "2");
            mouth.setAttribute("fill", "none");
            this.element.appendChild(mouth);

            gameContainer.appendChild(this.element);
        }

        update() {
            this.x += this.direction * 1;
            if (Math.random() < 0.01) this.direction *= -1;
            this.element.style.left = (this.x - cameraX) + 'px';
            this.element.style.top = (this.y - cameraY) + 'px';

            if (Date.now() - this.lastMessageTime > this.messageInterval) {
                this.sendMessage();
                this.lastMessageTime = Date.now();
                this.messageInterval = Math.random() * 10000 + 5000;
            }
        }

        sendMessage() {
            const message = NPC_MESSAGES[Math.floor(Math.random() * NPC_MESSAGES.length)];
            addChatMessage(`NPC: ${message}`);
            this.showSpeechBubble(message);
        }

        showSpeechBubble(message) {
            const bubble = document.createElement('div');
            bubble.className = 'speech-bubble';
            bubble.textContent = message;

            const npcRect = this.element.getBoundingClientRect();
            bubble.style.left = (npcRect.left + npcRect.width / 2) + 'px';
            bubble.style.bottom = (gameContainer.clientHeight - npcRect.top + 10) + 'px';

            gameContainer.appendChild(bubble);

            setTimeout(() => {
                bubble.style.opacity = '1';
            }, 50);

            setTimeout(() => {
                bubble.style.opacity = '0';
                setTimeout(() => {
                    gameContainer.removeChild(bubble);
                }, 300);
            }, 3000);
        }
    }

    let npcs = [];
    let isOnGround = false;
    let canJump = true;

    function generateNPCs() {
        for (let i = 0; i < 5; i++) {
            const x = Math.random() * gameContainer.clientWidth;
            const y = gameContainer.clientHeight - 132; // Place NPCs on the ground
            npcs.push(new NPC(x, y));
        }
    }

    let isAutoPlayingPiano = false;
    let autoPlayInterval;
    let isHorrorPianoPlaying = false;
    let horrorPianoInterval;

    function playNote(frequency) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 1);
    }

    function playHorrorNote(frequency) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 2);
    }

    function playRandomPianoKey() {
        const keys = Array.from(pianoKeys);
        const randomKey = keys[Math.floor(Math.random() * keys.length)];
        const note = randomKey.getAttribute('data-note');
        const frequency = noteFrequencies[note];
        playNote(frequency);
        randomKey.classList.add('active');
        setTimeout(() => {
            randomKey.classList.remove('active');
        }, 200);
    }

    function playRandomHorrorPianoKey() {
        const horrorPiano = document.getElementById('horror-piano');
        const keys = Array.from(horrorPiano.querySelectorAll('.piano-key'));
        const randomKey = keys[Math.floor(Math.random() * keys.length)];
        const note = randomKey.getAttribute('data-note');
        const frequency = horrorNoteFrequencies[note];
        playHorrorNote(frequency);
        randomKey.classList.add('active');
        setTimeout(() => {
            randomKey.classList.remove('active');
        }, 200);
    }

    function startAutoPiano() {
        if (!isAutoPlayingPiano) {
            isAutoPlayingPiano = true;
            autoPlayInterval = setInterval(playRandomPianoKey, 500);
        }
    }

    function stopAutoPiano() {
        if (isAutoPlayingPiano) {
            isAutoPlayingPiano = false;
            clearInterval(autoPlayInterval);
        }
    }

    function startHorrorPiano() {
        if (!isHorrorPianoPlaying) {
            isHorrorPianoPlaying = true;
            document.getElementById('horror-piano').style.display = 'flex';
            horrorPianoInterval = setInterval(playRandomHorrorPianoKey, 500);
        }
    }

    function stopHorrorPiano() {
        if (isHorrorPianoPlaying) {
            isHorrorPianoPlaying = false;
            clearInterval(horrorPianoInterval);
            document.getElementById('horror-piano').style.display = 'none';
        }
    }

    let playerX = 32;
    let playerY = 0;
    let cameraX = 0;
    let cameraY = 0;
    let gravity = 0.5;
    let verticalVelocity = 0;
    let blocks = [];
    let isGameDestroyed = false;

    let keys = {
        ArrowLeft: false,
        ArrowRight: false,
        Space: false
    };

    let platformGenerator = {
        nextX: gameContainer.clientWidth + 100
    };
    let leftmostPlatformX = 0;

    let secretClickCount = 0;
    const secretTrigger = document.getElementById('secret-trigger');

    function createBlock(x, y) {
        const block = document.createElement('div');
        block.className = 'block';
        block.style.left = (x - cameraX) + 'px';
        block.style.top = (y - cameraY) + 'px';
        gameContainer.appendChild(block);
        blocks.push({x, y, element: block});
        addChatMessage("Block created at " + x + ", " + y);
    }

    function createInitialPlatform() {
        const platformWidth = 5;
        const platformY = gameContainer.clientHeight - 100;
        
        for (let i = -15; i < 0; i++) {
            createBlock(i * 32, platformY);
        }
        
        for (let i = 0; i < platformWidth; i++) {
            createBlock(i * 32, platformY);
        }
        
        for (let i = platformWidth; i < platformWidth + 15; i++) {
            createBlock(i * 32, platformY);
        }
        
        playerX = 32;
        playerY = platformY - 48 - 2; // Add a 2-pixel gap

        platformGenerator.nextX = (platformWidth + 15) * 32;
        leftmostPlatformX = -15 * 32;
    }

    function createInventory() {
        for (let i = 0; i < 10; i++) {
            const slot = document.createElement('div');
            slot.className = 'inventory-slot';
            inventory.appendChild(slot);
        }
    }

    function updatePlayerPosition() {
        player.style.left = (playerX - cameraX) + 'px';
        player.style.top = (playerY - cameraY) + 'px';
    }

    function checkCollision() {
        isOnGround = false;
        for (const block of blocks) {
            if (
                playerX < block.x + 32 &&
                playerX + 32 > block.x &&
                playerY < block.y + 32 &&
                playerY + 48 > block.y
            ) {
                const overlapLeft = playerX + 32 - block.x;
                const overlapRight = block.x + 32 - playerX;
                const overlapTop = playerY + 48 - block.y;
                const overlapBottom = block.y + 32 - playerY;

                const minOverlap = Math.min(overlapLeft, overlapRight, overlapTop, overlapBottom);

                if (minOverlap === overlapTop && verticalVelocity >= 0) {
                    playerY = block.y - 48 - 2; // Add a 2-pixel gap
                    verticalVelocity = 0;
                    isOnGround = true;
                    canJump = true;
                } else if (minOverlap === overlapBottom && verticalVelocity < 0) {
                    playerY = block.y + 32;
                    verticalVelocity = 0;
                } else if (minOverlap === overlapLeft) {
                    playerX = block.x - 32;
                } else if (minOverlap === overlapRight) {
                    playerX = block.x + 32;
                }
            }
        }
        return isOnGround;
    }

    function jump() {
        if (canJump && isOnGround) {
            verticalVelocity = JUMP_STRENGTH;
            isJumping = true;
            jumpHoldTime = 0;
            canJump = false;
        }
    }

    function gameLoop() {
        if (isGameDestroyed) return;

        if (!gameLoop.initialized) {
            createInitialPlatform();
            generateNPCs();
            gameLoop.initialized = true;
        }

        checkCollision();

        if (!isOnGround) {
            verticalVelocity += gravity;
            if (isJumping && keys.Space && jumpHoldTime < MAX_JUMP_HOLD) {
                verticalVelocity = JUMP_STRENGTH;
                jumpHoldTime++;
            } else if (!keys.Space) {
                isJumping = false;
            }
        } else {
            isJumping = false;
            jumpHoldTime = 0;
            canJump = true;
        }

        playerY += verticalVelocity;

        if (keys.ArrowLeft) {
            playerX -= 5;
        }
        if (keys.ArrowRight) {
            playerX += 5;
        }

        checkCollision();

        verticalVelocity = Math.min(verticalVelocity, 10);

        if (playerY > gameContainer.clientHeight + 100) {
            selfDestruct();
            return;
        }

        cameraX = playerX - gameContainer.clientWidth / 2;
        cameraY = playerY - gameContainer.clientHeight / 2;

        updatePlayerPosition();
        updateBlockPositions();
        npcs.forEach(npc => npc.update());
        generatePlatforms();

        requestAnimationFrame(gameLoop);
    }

    function updateBlockPositions() {
        blocks.forEach(block => {
            block.element.style.left = (block.x - cameraX) + 'px';
            block.element.style.top = (block.y - cameraY) + 'px';
        });
    }

    function generatePlatforms() {
        while (playerX + gameContainer.clientWidth / 2 > platformGenerator.nextX) {
            const platformWidth = Math.floor(Math.random() * 5 + 3) * 32;
            const platformY = Math.floor(Math.random() * (gameContainer.clientHeight / 32)) * 32;

            for (let i = 0; i < platformWidth / 32; i++) {
                createBlock(platformGenerator.nextX + i * 32, platformY);
            }

            platformGenerator.nextX += platformWidth + Math.floor(Math.random() * 5 + 2) * 32;
        }

        while (playerX - gameContainer.clientWidth / 2 < leftmostPlatformX) {
            const platformWidth = Math.floor(Math.random() * 5 + 3) * 32;
            const platformY = Math.floor(Math.random() * (gameContainer.clientHeight / 32)) * 32;

            for (let i = 0; i < platformWidth / 32; i++) {
                createBlock(leftmostPlatformX - i * 32, platformY);
            }

            leftmostPlatformX -= platformWidth + Math.floor(Math.random() * 5 + 2) * 32;
        }
    }

    function addChatMessage(message) {
        const chatEntry = document.createElement('div');
        chatEntry.textContent = message;
        chatLog.appendChild(chatEntry);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function showSpeechBubble(message) {
        const bubble = document.createElement('div');
        bubble.className = 'speech-bubble';
        bubble.textContent = message;

        const playerRect = player.getBoundingClientRect();
        bubble.style.left = (playerRect.left + playerRect.width / 2) + 'px';
        bubble.style.bottom = (gameContainer.clientHeight - playerRect.top + 10) + 'px';

        gameContainer.appendChild(bubble);

        setTimeout(() => {
            bubble.style.opacity = '1';
        }, 50);

        setTimeout(() => {
            bubble.style.opacity = '0';
            setTimeout(() => {
                gameContainer.removeChild(bubble);
            }, 300);
        }, 3000);
    }

    function generateCorruptedText() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+{}[]|;:,.<>?';
        return Array(20).fill().map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    function addCorruptedText() {
        const text = document.createElement('div');
        text.style.position = 'fixed';
        text.style.color = `rgb(${Math.random()*255},${Math.random()*255},${Math.random()*255})`;
        text.style.fontSize = `${Math.random() * 20 + 10}px`;
        text.style.fontFamily = 'monospace';
        text.style.left = `${Math.random() * window.innerWidth}px`;
        text.style.top = `${Math.random() * window.innerHeight}px`;
        text.style.transform = `rotate(${Math.random() * 360}deg)`;
        text.style.pointerEvents = 'none';
        text.textContent = generateCorruptedText();
        document.body.appendChild(text);
    }

    function addCreepyMessage() {
        const messages = [
            "YOU ARE GOING TO DIE IN FIVE DAYS",
            "THERE'S NO ESCAPE",
            "IT'S WATCHING YOU",
            "BEHIND YOU",
            "DON'T LOOK AWAY"
        ];
        const text = document.createElement('div');
        text.style.position = 'fixed';
        text.style.color = 'red';
        text.style.fontSize = `${Math.random() * 30 + 20}px`;
        text.style.fontFamily = 'Arial, sans-serif';
        text.style.fontWeight = 'bold';
        text.style.left = `${Math.random() * window.innerWidth}px`;
        text.style.top = `${Math.random() * window.innerHeight}px`;
        text.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
        text.style.pointerEvents = 'none';
        text.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
        text.textContent = messages[Math.floor(Math.random() * messages.length)];
        document.body.appendChild(text);
    }

    function preloadAudio(url) {
        return new Promise((resolve, reject) => {
            const audio = new Audio();
            audio.addEventListener('canplaythrough', resolve);
            audio.addEventListener('error', reject);
            audio.src = url;
        });
    }

    function selfDestruct() {
        isGameDestroyed = true;
        stopAutoPiano();
        startHorrorPiano();

        const bombExplosion = document.createElement('div');
        bombExplosion.className = 'bomb-explosion';
        document.body.appendChild(bombExplosion);

        const horrorSounds = document.getElementById('horror-sounds');
        horrorSounds.play().catch(e => console.error('Failed to play horror sounds:', e));

        const creepyPiano = document.getElementById('creepy-piano');
        creepyPiano.play().catch(e => console.error('Failed to play creepy piano:', e));

        setTimeout(() => {
            document.body.removeChild(bombExplosion);
            glitchOverlay.classList.add('glitch-active');

            const glitchCanvas = document.createElement('canvas');
            glitchCanvas.width = window.innerWidth;
            glitchCanvas.height = window.innerHeight;
            const ctx = glitchCanvas.getContext('2d');
            glitchOverlay.appendChild(glitchCanvas);

            function drawGlitch() {
                ctx.clearRect(0, 0, glitchCanvas.width, glitchCanvas.height);

                for (let i = 0; i < 50; i++) {
                    ctx.fillStyle = `rgba(${Math.random() * 255},${Math.random() * 255},${Math.random() * 255},${Math.random()})`;
                    ctx.fillRect(
                        Math.random() * glitchCanvas.width,
                        Math.random() * glitchCanvas.height,
                        Math.random() * 100,
                        Math.random() * 100
                    );
                }

                for (let i = 0; i < 100; i++) {
                    ctx.strokeStyle = `rgba(${Math.random() * 255},${Math.random() * 255},${Math.random() * 255},${Math.random()})`;
                    ctx.beginPath();
                    ctx.moveTo(Math.random() * glitchCanvas.width, Math.random() * glitchCanvas.height);
                    ctx.lineTo(Math.random() * glitchCanvas.width, Math.random() * glitchCanvas.height);
                    ctx.stroke();
                }

                if (Math.random() < 0.1) {
                    addCorruptedText();
                }
                if (Math.random() < 0.05) {
                    addCreepyMessage();
                }

                requestAnimationFrame(drawGlitch);
            }

            drawGlitch();

            document.querySelectorAll('*').forEach(el => {
                if (el !== glitchOverlay && el !== glitchCanvas) {
                    el.style.filter = 'blur(2px) hue-rotate(90deg)';
                    el.style.transform = `skew(${Math.random() * 10 - 5}deg, ${Math.random() * 10 - 5}deg)`;
                }
            });

            addChatMessage("SYSTEM FAILURE: GAME CORRUPTED");

            // Show the restart button
            const restartButton = document.getElementById('restart-button');
            restartButton.style.display = 'block';
        }, 1000);
    }

    function restartGame() {
        // Remove all existing elements
        while (gameContainer.firstChild) {
            gameContainer.removeChild(gameContainer.firstChild);
        }
        
        // Reset game state
        isGameDestroyed = false;
        playerX = 32;
        playerY = 0;
        cameraX = 0;
        cameraY = 0;
        verticalVelocity = 0;
        blocks = [];
        npcs = [];
        
        // Reset UI
        chatLog.innerHTML = '';
        glitchOverlay.classList.remove('glitch-active');
        document.querySelectorAll('*').forEach(el => {
            el.style.filter = '';
            el.style.transform = '';
        });
        
        // Remove corrupted text and creepy messages
        document.querySelectorAll('div[style*="position: fixed"]').forEach(el => {
            if (el !== document.getElementById('restart-button')) {
                el.remove();
            }
        });
        
        // Hide restart button
        document.getElementById('restart-button').style.display = 'none';
        
        // Stop horror sounds
        const horrorSounds = document.getElementById('horror-sounds');
        horrorSounds.pause();
        horrorSounds.currentTime = 0;
        
        const creepyPiano = document.getElementById('creepy-piano');
        creepyPiano.pause();
        creepyPiano.currentTime = 0;
        
        // Restart game
        createInitialPlatform();
        generateNPCs();
        createInventory();
        addChatMessage("Welcome to Cute Cat Platformer!");
        addChatMessage("Use arrow keys to move. Click to place cute blocks.");
        showWelcomeMessage();
        startAutoPiano();
        gameLoop();
    }

    function showWelcomeMessage() {
        const welcomeMessage = document.getElementById('welcome-message');
        welcomeMessage.style.display = 'block';
        setTimeout(() => {
            welcomeMessage.style.display = 'none';
        }, 5000); // Hide after 5 seconds
    }

    Promise.all([
        preloadAudio('https://terrariaclone.com/creepy-piano.mp3'),
        preloadAudio('https://terrariaclone.com/broken-music.mp3'),
        preloadAudio('https://terrariaclone.com/horror-sounds.mp3')
    ]).then(() => {
        console.log('Audio files preloaded successfully');
    }).catch(error => {
        console.error('Failed to preload audio files:', error);
    });

    secretTrigger.addEventListener('click', () => {
        secretClickCount++;
        if (secretClickCount >= 5) {
            selfDestruct();
        } else {
            setTimeout(resetSecretClickCount, 3000);
        }
    });

    pianoKeys.forEach(key => {
        key.addEventListener('mousedown', () => {
            const note = key.getAttribute('data-note');
            const frequency = noteFrequencies[note];
            playNote(frequency);
            key.classList.add('active');
        });

        key.addEventListener('mouseup', () => {
            key.classList.remove('active');
        });

        key.addEventListener('mouseleave', () => {
            key.classList.remove('active');
        });
    });

    document.addEventListener('keydown', (e) => {
        if (isGameDestroyed) return;

        switch (e.code) {
            case 'ArrowLeft':
            case 'ArrowRight':
            case 'Space':
                keys[e.code] = true;
                if (e.code === 'Space') {
                    jump();
                }
                break;
        }
    });

    document.addEventListener('keyup', (e) => {
        if (isGameDestroyed) return;

        if (e.code === 'ArrowLeft' || e.code === 'ArrowRight' || e.code === 'Space') {
            keys[e.code] = false;
        }
    });

    gameContainer.addEventListener('click', (e) => {
        if (isGameDestroyed) return;

        const rect = gameContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left + cameraX;
        const clickY = e.clientY - rect.top + cameraY;
        createBlock(Math.floor(clickX / 32) * 32, Math.floor(clickY / 32) * 32);
    });

    chatSend.addEventListener('click', () => {
        const message = chatMessage.value.trim();
        if (message) {
            addChatMessage("Player: " + message);
            showSpeechBubble(message);
            chatMessage.value = '';
        }
    });

    chatMessage.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            chatSend.click();
        }
    });

    document.getElementById('restart-button').addEventListener('click', restartGame);

    window.addEventListener('load', () => {
        createInventory();
        addChatMessage("Welcome to Cute Cat Platformer!");
        addChatMessage("Use arrow keys to move. Click to place cute blocks.");
        gameLoop();
        startAutoPiano();
        showWelcomeMessage();
    });
</script>
</body>
</html>